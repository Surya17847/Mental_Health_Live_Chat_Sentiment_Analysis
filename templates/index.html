<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Sentiment Detection - Big Data Analytics</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .crisis-pulse {
            animation: pulse 2s infinite;
            border: 2px solid #ef4444;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .positive { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        .negative { border-left: 4px solid #ef4444; background-color: #fef2f2; }
        .neutral { border-left: 4px solid #6b7280; background-color: #f9fafb; }
        .crisis { border-left: 4px solid #dc2626; background-color: #fef2f2; animation: crisisFlash 1s infinite; }
        @keyframes crisisFlash {
            0%, 100% { background-color: #fef2f2; }
            50% { background-color: #fecaca; }
        }
        .mental-health-badge { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
        
        .project-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .project-details.open {
            max-height: 2000px;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8 bg-white rounded-2xl shadow-lg p-8">
            <div class="flex items-center justify-center mb-4">
                <span class="text-4xl mr-4">üß†</span>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Mental Health Sentiment Detection
                </h1>
            </div>
            <p class="text-lg text-gray-600 mb-4">Real-time Big Data Analytics using Pure Python Message Bus</p>
            <div class="flex justify-center space-x-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                    Message Bus
                </span>
                <span class="flex items-center">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span>
                    Real-time AI
                </span>
                <span class="flex items-center">
                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-2 animate-pulse"></span>
                    Crisis Detection
                </span>
            </div>
            
            <!-- Project Details Dropdown -->
            <div class="mt-6">
                <button id="project-details-toggle" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition duration-300 transform hover:scale-105 flex items-center mx-auto">
                    <span>About This Project</span>
                    <svg id="dropdown-arrow" class="w-5 h-5 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div id="project-details" class="project-details mt-4 text-left">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl border-2 border-blue-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">üéØ Project Overview</h3>
                        <p class="text-gray-700 mb-4">
                            This is a real-time mental health sentiment detection system that combines Big Data concepts with AI-powered analysis to monitor and analyze mental health discussions in real-time.
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <!-- Technologies Used -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-blue-600 mb-3 flex items-center">
                                    <span class="mr-2">üõ†Ô∏è</span> Technologies Used
                                </h4>
                                <ul class="space-y-2 text-sm text-gray-700">
                                    <li><strong>Backend:</strong> Flask (Python Web Framework)</li>
                                    <li><strong>Real-time:</strong> Flask-SocketIO (WebSocket)</li>
                                    <li><strong>Message Bus:</strong> Custom Pure Python Implementation</li>
                                    <li><strong>AI/ML:</strong> VADER Sentiment + TextBlob</li>
                                    <li><strong>Storage:</strong> In-Memory Data Storage</li>
                                    <li><strong>Visualization:</strong> Plotly.js Charts</li>
                                    <li><strong>Frontend:</strong> HTML5, TailwindCSS, JavaScript</li>
                                </ul>
                            </div>
                            
                            <!-- Key Features -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-purple-600 mb-3 flex items-center">
                                    <span class="mr-2">‚≠ê</span> Key Features
                                </h4>
                                <ul class="space-y-2 text-sm text-gray-700">
                                    <li>‚úÖ Real-time sentiment analysis</li>
                                    <li>‚úÖ Mental health context detection</li>
                                    <li>‚úÖ Crisis alert system</li>
                                    <li>‚úÖ Live message streaming</li>
                                    <li>‚úÖ Interactive data visualization</li>
                                    <li>‚úÖ Duplicate prevention mechanism</li>
                                    <li>‚úÖ Pure Python message bus (No Kafka)</li>
                                </ul>
                            </div>
                            
                            <!-- Big Data Concepts -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-green-600 mb-3 flex items-center">
                                    <span class="mr-2">üìä</span> Big Data Concepts
                                </h4>
                                <ul class="space-y-2 text-sm text-gray-700">
                                    <li><strong>Stream Processing:</strong> Real-time data flow</li>
                                    <li><strong>Message Queue:</strong> Pub-Sub architecture</li>
                                    <li><strong>Data Pipeline:</strong> ETL processing</li>
                                    <li><strong>Real-time Analytics:</strong> Live metrics</li>
                                    <li><strong>Event-Driven:</strong> Async processing</li>
                                    <li><strong>Scalable Design:</strong> Modular components</li>
                                </ul>
                            </div>
                            
                            <!-- AI/ML Models -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-orange-600 mb-3 flex items-center">
                                    <span class="mr-2">ü§ñ</span> AI/ML Models
                                </h4>
                                <ul class="space-y-2 text-sm text-gray-700">
                                    <li><strong>VADER:</strong> Sentiment intensity analyzer</li>
                                    <li><strong>TextBlob:</strong> Polarity & subjectivity</li>
                                    <li><strong>Custom Keywords:</strong> Mental health terms</li>
                                    <li><strong>Severity Scoring:</strong> Risk level detection</li>
                                    <li><strong>Context Analysis:</strong> Domain-specific NLP</li>
                                    <li><strong>Crisis Detection:</strong> Pattern matching</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Architecture -->
                        <div class="bg-white p-4 rounded-lg shadow mt-6">
                            <h4 class="text-lg font-bold text-indigo-600 mb-3 flex items-center">
                                <span class="mr-2">üèóÔ∏è</span> System Architecture
                            </h4>
                            <div class="text-sm text-gray-700 space-y-2">
                                <p><strong>1. Message Input:</strong> User sends message via web interface</p>
                                <p><strong>2. Message Bus:</strong> Pure Python pub-sub system queues message</p>
                                <p><strong>3. AI Processing:</strong> VADER + TextBlob analyze sentiment</p>
                                <p><strong>4. Data Storage:</strong> Results stored in-memory</p>
                                <p><strong>5. Real-time Updates:</strong> WebSocket broadcasts to all clients</p>
                                <p><strong>6. Visualization:</strong> Live charts and statistics update</p>
                                <p><strong>7. Crisis Detection:</strong> Alerts triggered for high-risk messages</p>
                            </div>
                        </div>
                        
                        <!-- Use Cases -->
                        <div class="bg-white p-4 rounded-lg shadow mt-6">
                            <h4 class="text-lg font-bold text-pink-600 mb-3 flex items-center">
                                <span class="mr-2">üí°</span> Real-World Applications
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                                <div>
                                    <p class="font-semibold mb-1">üè• Healthcare:</p>
                                    <p>Monitor patient mental health in telehealth platforms</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1">üéì Education:</p>
                                    <p>Track student wellbeing in online learning</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1">üíº Corporate:</p>
                                    <p>Employee wellness monitoring and support</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1">üåê Social Media:</p>
                                    <p>Content moderation and user safety</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Status Panel -->
        <div class="mb-6 bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <span class="mr-2">‚öôÔ∏è</span> System Status
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" id="services-status">
                <div class="text-center p-4 bg-green-100 rounded-lg border-2 border-green-300">
                    <div class="text-sm font-medium text-gray-600">Message Bus</div>
                    <div class="text-lg font-semibold text-green-600">‚úÖ Running</div>
                </div>
                <div class="text-center p-4 bg-green-100 rounded-lg border-2 border-green-300">
                    <div class="text-sm font-medium text-gray-600">Sentiment AI</div>
                    <div class="text-lg font-semibold text-green-600">‚úÖ Active</div>
                </div>
                <div class="text-center p-4 bg-blue-100 rounded-lg border-2 border-blue-300">
                    <div class="text-sm font-medium text-gray-600">Data Storage</div>
                    <div class="text-lg font-semibold text-blue-600">‚úÖ In-Memory</div>
                </div>
            </div>
            <div class="text-center text-sm text-gray-600">
                Powered by Pure Python Message Bus ‚Ä¢ Real-time AI Analysis ‚Ä¢ Big Data Concepts
            </div>
        </div>

        <!-- Big Data Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Messages -->
            <div class="bg-white rounded-2xl shadow-lg p-6 transform hover:scale-105 transition duration-300 border-t-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Messages</p>
                        <p id="total-messages" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-xl">
                        <span class="text-2xl text-blue-600">üí¨</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">Processed in real-time</div>
            </div>

            <!-- Positive Sentiment -->
            <div class="bg-white rounded-2xl shadow-lg p-6 transform hover:scale-105 transition duration-300 border-t-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Positive</p>
                        <p id="positive-percent" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-xl">
                        <span class="text-2xl text-green-600">üòä</span>
                    </div>
                </div>
                <div id="positive-count" class="mt-2 text-xs text-gray-500">0 messages</div>
            </div>

            <!-- Negative Sentiment -->
            <div class="bg-white rounded-2xl shadow-lg p-6 transform hover:scale-105 transition duration-300 border-t-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Negative</p>
                        <p id="negative-percent" class="text-3xl font-bold text-red-600">0%</p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-xl">
                        <span class="text-2xl text-red-600">üòî</span>
                    </div>
                </div>
                <div id="negative-count" class="mt-2 text-xs text-gray-500">0 messages</div>
            </div>

            <!-- Crisis Alerts -->
            <div id="crisis-stat" class="bg-white rounded-2xl shadow-lg p-6 transform hover:scale-105 transition duration-300 crisis-pulse hidden border-t-4 border-red-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-red-600">Crisis Alerts</p>
                        <p id="crisis-count" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-xl">
                        <span class="text-2xl text-red-600">üö®</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-red-500">Immediate attention needed</div>
            </div>
        </div>

        <!-- Charts and Chat Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Sentiment Chart -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 border-t-4 border-purple-500">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">üìä</span> Real-time Sentiment Analysis
                </h3>
                <div id="sentiment-chart" class="h-80"></div>
            </div>

            <!-- Chat Interface -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-indigo-500">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">üí≠</span> Mental Health Chat
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                        <input type="text" id="username-input" 
                               class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                               value="WellnessSeeker" placeholder="Enter your name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Message</label>
                        <textarea id="message-input" 
                                  class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-32 transition duration-200"
                                  placeholder="Share how you're feeling... (e.g., 'Feeling anxious about work' or 'Had a great therapy session')"></textarea>
                    </div>
                    <button id="send-btn" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-300 transform hover:scale-105 shadow-lg">
                        Send & Analyze Message
                    </button>
                    <div class="text-xs text-gray-500 text-center bg-blue-50 p-2 rounded">
                        Messages are processed in real-time using Pure Python Message Bus
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Feed and Alerts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Live Message Feed -->
            <div class="bg-white rounded-2xl shadow-lg border-t-4 border-green-500">
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-blue-50">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="mr-2">üî¥</span> Live Message Feed
                    </h3>
                </div>
                <div id="chat-feed" class="h-96 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4 animate-bounce">üí¨</div>
                        <p class="font-semibold">Send a message to see real-time sentiment analysis</p>
                        <p class="text-sm mt-2">Powered by Pure Python Message Bus & AI</p>
                    </div>
                </div>
            </div>

            <!-- Crisis Alerts Panel -->
            <div id="crisis-panel" class="bg-white rounded-2xl shadow-lg hidden border-t-4 border-red-600">
                <div class="p-4 border-b border-red-200 bg-gradient-to-r from-red-50 to-orange-50">
                    <h3 class="text-lg font-semibold text-red-800 flex items-center">
                        <span class="mr-2">üö®</span> Crisis Detection Alerts
                    </h3>
                </div>
                <div id="crisis-alerts" class="h-96 overflow-y-auto p-4 space-y-3">
                    <!-- Crisis alerts will appear here -->
                </div>
            </div>

            <!-- System Insights -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg border-t-4 border-yellow-500">
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-orange-50">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="mr-2">üìà</span> System Insights
                    </h3>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border-2 border-blue-200 transform hover:scale-105 transition duration-300">
                        <div class="text-2xl font-bold text-blue-600" id="avg-sentiment">0.00</div>
                        <div class="text-sm text-blue-600 font-semibold">Avg Sentiment Score</div>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border-2 border-purple-200 transform hover:scale-105 transition duration-300">
                        <div class="text-2xl font-bold text-purple-600" id="mental-health-count">0</div>
                        <div class="text-sm text-purple-600 font-semibold">Mental Health Messages</div>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border-2 border-green-200 transform hover:scale-105 transition duration-300">
                        <div class="text-2xl font-bold text-green-600" id="attention-needed">0%</div>
                        <div class="text-sm text-green-600 font-semibold">Need Attention</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Big Data Tools Footer -->
        <div class="mt-8 text-center text-gray-500 bg-white rounded-xl shadow-lg p-6">
            <p class="font-semibold text-lg mb-2">Powered by:</p>
            <p><span class="font-semibold text-blue-600">Pure Python Message Bus</span> ‚Ä¢ <span class="font-semibold text-purple-600">Real-time AI Analysis</span> ‚Ä¢ <span class="font-semibold text-red-600">Crisis Detection</span></p>
            <p class="text-sm mt-3 text-gray-600">Mental Health Sentiment Detection - Big Data Analytics Project</p>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();

        // Chart instances
        let sentimentChart;

        // Duplicate prevention with improved tracking
        const messageHistory = new Map(); // Use Map to store message with timestamp
        const DUPLICATE_WINDOW = 2000; // 2 seconds window for duplicate detection
        let isFetching = false;
        let sendingMessage = false;

        // Initialize charts
        function initializeCharts() {
            const sentimentData = [{
                values: [0, 0, 0, 0],
                labels: ['Positive', 'Negative', 'Neutral', 'Crisis'],
                type: 'pie',
                marker: {
                    colors: ['#10b981', '#ef4444', '#6b7280', '#dc2626']
                },
                textinfo: 'label+percent',
                insidetextorientation: 'radial',
                hoverinfo: 'label+value+percent',
                hole: 0.4
            }];

            const layout = {
                height: 320,
                showlegend: true,
                margin: { t: 0, b: 0, l: 0, r: 0 },
                annotations: [{
                    text: 'Sentiment',
                    showarrow: false,
                    font: { size: 14 }
                }]
            };

            sentimentChart = document.getElementById('sentiment-chart');
            Plotly.newPlot(sentimentChart, sentimentData, layout);
        }

        // Generate unique message ID
        function generateMessageId(sentimentData) {
            const username = sentimentData.username || 'Anonymous';
            const text = sentimentData.text || sentimentData.message || '';
            // Use a simpler ID that's less prone to timing issues
            return `${username}_${text.substring(0, 50)}`.toLowerCase().replace(/\s+/g, '_');
        }

        // Check if message is duplicate within time window
        function isDuplicateMessage(messageId) {
            const now = Date.now();
            
            // Clean old entries
            for (const [id, timestamp] of messageHistory.entries()) {
                if (now - timestamp > DUPLICATE_WINDOW) {
                    messageHistory.delete(id);
                }
            }
            
            // Check if this message exists in recent history
            if (messageHistory.has(messageId)) {
                const lastSeen = messageHistory.get(messageId);
                if (now - lastSeen < DUPLICATE_WINDOW) {
                    console.log('Duplicate detected within window:', messageId);
                    return true;
                }
            }
            
            // Add to history
            messageHistory.set(messageId, now);
            return false;
        }

        // Update statistics display
        function updateStatsDisplay(stats) {
            if (!stats) return;

            try {
                document.getElementById('total-messages').textContent = (stats.total_messages || 0).toLocaleString();
                document.getElementById('positive-percent').textContent = (stats.positive_percent || 0).toFixed(1) + '%';
                document.getElementById('negative-percent').textContent = (stats.negative_percent || 0).toFixed(1) + '%';
                document.getElementById('positive-count').textContent = (stats.sentiment_counts?.POSITIVE || 0) + ' messages';
                document.getElementById('negative-count').textContent = (stats.sentiment_counts?.NEGATIVE || 0) + ' messages';
                document.getElementById('crisis-count').textContent = stats.sentiment_counts?.CRISIS || 0;

                document.getElementById('avg-sentiment').textContent = (stats.average_sentiment || 0).toFixed(2);
                document.getElementById('mental-health-count').textContent = stats.mental_health_messages || 0;
                document.getElementById('attention-needed').textContent = (stats.crisis_percent || 0).toFixed(1) + '%';

                const values = [
                    stats.sentiment_counts?.POSITIVE || 0,
                    stats.sentiment_counts?.NEGATIVE || 0,
                    stats.sentiment_counts?.NEUTRAL || 0,
                    stats.sentiment_counts?.CRISIS || 0
                ];

                Plotly.update(sentimentChart, { values: [values] });

                const crisisStat = document.getElementById('crisis-stat');
                const crisisPanel = document.getElementById('crisis-panel');
                if (crisisStat && crisisPanel && (stats.sentiment_counts?.CRISIS || 0) > 0) {
                    crisisStat.classList.remove('hidden');
                    crisisPanel.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Add message to chat feed with duplicate prevention
        function addMessageToFeed(sentimentData) {
            if (!sentimentData || !sentimentData.text) return;

            const messageId = generateMessageId(sentimentData);
            
            // Check for duplicate
            if (isDuplicateMessage(messageId)) {
                return;
            }

            const chatFeed = document.getElementById('chat-feed');
            if (!chatFeed) return;
            
            const placeholder = chatFeed.querySelector('.text-center');
            if (placeholder) placeholder.remove();

            const messageDiv = document.createElement('div');
            const sentiment = sentimentData;
            
            let sentimentClass = 'neutral';
            let sentimentIcon = 'üòê';
            let sentimentText = 'Neutral';
            
            switch(sentiment.sentiment_label) {
                case 'POSITIVE':
                    sentimentClass = 'positive';
                    sentimentIcon = 'üòä';
                    sentimentText = 'Positive';
                    break;
                case 'NEGATIVE':
                    sentimentClass = 'negative';
                    sentimentIcon = 'üòî';
                    sentimentText = 'Negative';
                    break;
                case 'CRISIS':
                    sentimentClass = 'crisis';
                    sentimentIcon = 'üö®';
                    sentimentText = 'Crisis';
                    break;
            }

            const isMentalHealth = sentiment.mental_health_context?.has_any_context || false;

            messageDiv.className = `p-4 rounded-lg ${sentimentClass} transform transition duration-300 hover:scale-105`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-gray-800">${sentiment.username || 'Anonymous'}</span>
                        <span class="text-xs text-gray-500">${new Date(sentiment.timestamp).toLocaleTimeString()}</span>
                        ${isMentalHealth ? '<span class="mental-health-badge text-xs text-white px-2 py-1 rounded-full">Mental Health</span>' : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">${sentimentIcon}</span>
                        <span class="text-sm font-semibold ${sentiment.sentiment_label === 'POSITIVE' ? 'text-green-600' : sentiment.sentiment_label === 'NEGATIVE' ? 'text-red-600' : sentiment.sentiment_label === 'CRISIS' ? 'text-red-700' : 'text-gray-600'}">
                            ${sentimentText}
                        </span>
                    </div>
                </div>
                <p class="text-gray-700 mb-2">${sentiment.text}</p>
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <span>Score: ${((sentiment.sentiment_score || 0) * 100).toFixed(0)}%</span>
                    <span>Confidence: ${((sentiment.confidence || 0) * 100).toFixed(0)}%</span>
                    ${sentiment.needs_attention ? '<span class="text-red-500 font-semibold">‚ö†Ô∏è Needs Attention</span>' : ''}
                </div>
            `;

            chatFeed.prepend(messageDiv);
            
            if (chatFeed.children.length > 20) {
                chatFeed.removeChild(chatFeed.lastChild);
            }
        }

        // Add crisis alert with duplicate prevention
        function addCrisisAlert(alert) {
            if (!alert || !alert.message) return;

            const alertId = `crisis_${alert.username}_${alert.message.substring(0, 50)}`.toLowerCase().replace(/\s+/g, '_');
            
            if (isDuplicateMessage(alertId)) {
                return;
            }

            const alertsContainer = document.getElementById('crisis-alerts');
            if (!alertsContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'p-4 bg-red-50 border-2 border-red-300 rounded-lg crisis-pulse transform hover:scale-105 transition duration-300';
            alertDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-semibold text-red-800">${alert.username || 'Anonymous'}</span>
                        <span class="text-sm text-red-600 ml-2">${new Date(alert.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">CRISIS</span>
                </div>
                <p class="text-red-800 font-medium mb-2">${alert.message}</p>
                <div class="text-xs text-red-600 font-semibold">
                    üö® Immediate attention required - High risk detected
                </div>
            `;

            alertsContainer.prepend(alertDiv);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification('üö® Crisis Alert', {
                        body: `${alert.username}: ${alert.message}`,
                        icon: '/favicon.ico'
                    });
                } catch (error) {
                    console.error('Error showing notification:', error);
                }
            }
        }

        // Socket event handlers
        socket.on('connection_established', function(data) {
            console.log('Connected to server');
        });

        socket.on('sentiment_update', function(data) {
            if (data && data.sentiment_data) {
                addMessageToFeed(data.sentiment_data);
            }
            if (data && data.stats) {
                updateStatsDisplay(data.stats);
            }
        });

        socket.on('crisis_alert', function(alert) {
            if (alert) {
                addCrisisAlert(alert);
            }
        });

        socket.on('connect_error', function(error) {
            console.error('Socket connection error:', error);
        });

        socket.on('error', function(error) {
            console.error('Socket error:', error);
        });

        // Send message function (only via Socket.IO to prevent duplicates)
        function sendMessage() {
            if (sendingMessage) {
                console.log('Message already being sent, please wait');
                return;
            }

            const usernameInput = document.getElementById('username-input');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!usernameInput || !messageInput) {
                console.error('Required input elements not found');
                return;
            }

            const username = usernameInput.value.trim() || 'Anonymous';
            const message = messageInput.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Prevent double sending
            sendingMessage = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            // Send ONLY via Socket.IO
            try {
                socket.emit('send_chat_message', {
                    username: username,
                    message: message
                });
                
                // Clear input immediately
                messageInput.value = '';
                
                // Re-enable button after delay
                setTimeout(() => {
                    sendingMessage = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send & Analyze Message';
                }, 1000);
                
            } catch (error) {
                console.error('Error sending message:', error);
                sendingMessage = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send & Analyze Message';
            }
        }

        // Button event listeners
        document.getElementById('send-btn')?.addEventListener('click', sendMessage);
        
        document.getElementById('message-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Project details toggle
        const toggleBtn = document.getElementById('project-details-toggle');
        const detailsDiv = document.getElementById('project-details');
        const arrow = document.getElementById('dropdown-arrow');

        toggleBtn?.addEventListener('click', function() {
            detailsDiv.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
        });

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission().catch(error => {
                console.error('Error requesting notification permission:', error);
            });
        }

        // Initialize the application
        initializeCharts();

        // Safe fetch function
        async function safeFetch(url, options = {}) {
            if (isFetching) {
                return null;
            }
            
            isFetching = true;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                return null;
            } finally {
                isFetching = false;
            }
        }

        // Load initial stats
        safeFetch('/api/stats').then(updateStatsDisplay);

        // Load recent messages (only once on page load)
        safeFetch('/api/recent-messages').then(messages => {
            if (messages && Array.isArray(messages)) {
                messageHistory.clear();
                messages.reverse().forEach(addMessageToFeed);
            }
        });

        // Auto-update stats every 5 seconds
        setInterval(() => {
            safeFetch('/api/stats').then(updateStatsDisplay);
        }, 5000);

        // Clean up message history periodically
        setInterval(() => {
            const now = Date.now();
            for (const [id, timestamp] of messageHistory.entries()) {
                if (now - timestamp > 30000) { // Remove entries older than 30 seconds
                    messageHistory.delete(id);
                }
            }
        }, 30000);
    </script>
</body>
</html>